<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ラテール　ダメージ計算機</title>

	<!-- Tailwind CSS CDN -->
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						'bg': '#FFF5F7',
						'bg-secondary': '#FFE4E9',
						'bg-tertiary': '#FFDDE4',
						'border': '#FFB3BA',
						'border-light': '#FFCCDB',
						'text': '#3D2E40',
						'text-muted': '#6B5D6E',
						'text-dim': '#8B7D8E',
						'accent': '#E91E8C',
						'accent-hover': '#D61478',
						'danger': '#E6346D',
						'warning': '#E6A800',
						'success': '#2FA088',
						'input-bg': '#FFFFFF',
						'tab-active': '#FFE4E9',
						'tab-inactive': '#FFF5F7',
					},
					fontSize: {
						'2xs': '0.625rem',
					},
					spacing: {
						'18': '4.5rem',
					}
				}
			}
		}
	</script>
	<!-- コンパイル済みCSS -->
	<link rel="stylesheet" href="styles.css">
	<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
	<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>

<body class="min-h-screen bg-bg text-text">
	<div class="container mx-auto max-w-5xl p-4">
		<!-- タイトル部分 -->
		<div class="title-container">
			<h1 class="title-text">
				ラテール　ダメージ計算機
			</h1>
		</div>
		<details class="details-container">
			<summary class="details-summary">説明</summary>
			<div class="details-content">
				<p>平均ダメージはボス一般とすべてのスキル平均値です</p>
				<p>その他のダメージは選択中のボスor一般とスキルに対するダメージです</p>
				<p>最終と％以外はステータス画面に表示された値を直接入れてください</p>
				<p>最終と％はダメージ計算には使用しません。上昇ダメージ計算に使用するため超越なんかで固定値を100増やしたり減らしたりして [変化するステ画面の数値 - 100] を入れてください</p>
				<p>赤文字はそのステータス +1 当たりダメ上昇です(表示値ではなくエンチャ等で伸ばした場合の値)</p>
				<p>貫通は実際には整数値のみしか意味がありませんが少数値での価値を表示しています</p>
			</div>
		</details>

		<label class="dropzone">
			<input type="file" id="file-input" class="hidden">
			<span class="text-xs">📷 スクリーンショットから自動入力</span>
		</label>
	<p id="progress" class="progress-text"></p>

	<div id="app">

		<!-- メインタブナビゲーション -->
		<div class="tab-container">
			<div class="tab-list">
				<button v-for="(tabLabel, tabId) in tabLabels" :key="tabId" @click="onTabChange(tabId)"
					:class="{ 'active': activeMainTab === tabId }">
					{{ tabLabel }}
				</button>
			</div>
		</div>

			<!-- メインタブコンテンツ -->
			<div class="tab-content">
				<!-- ダメージ計算タブ -->
				<div v-if="activeMainTab === 'damage'">
			<!-- 加重平均ダメージ表示 -->
			<div class="mt-3 p-3 bg-accent bg-opacity-10 rounded-lg text-center">
				<div class="text-sm text-text-muted mb-1">
					一般 {{ (100 - ボス重要度) }}% + ボス {{ ボス重要度 }}% 平均ダメージ
				</div>
				<div class="text-2xl font-bold text-accent">{{ formatDamage(results.weightedDamage || 0) }}</div>
			</div>

			<!-- ダメージカード表示 -->
			<div class="grid-damage-cards-4 mt-3">
				<div>
					<div>単発青ダメ</div>
					<div>{{ formatDamage(現在スキル単発ダメージ.baseDamage) }}</div>
				</div>
				<div>
					<div>単発クリダメ</div>
					<div>{{ formatDamage(現在スキル単発ダメージ.criDamage) }}</div>
				</div>
			<div>
				<div>クリ率</div>
				<div>{{ (現在スキル単発ダメージ.criRate).toFixed(1) }}%</div>
			</div>
			<div>
				<div>平均スキルダメ</div>
				<div>{{ formatDamage(現在スキル単発ダメージ.damage * 現在スキル.HIT数) }}</div>
			</div>
			</div>

				<button id="copy" class="copy-button">
					コピーする
				</button>

				<div class="skill-settings mb-4">
					<div class="label-accent">スキル設定</div>
					
				<div class="flex items-end gap-4 mb-3">
					<div>
						<label>職業</label>
						<select v-model="共通職業" @change="onCommonJobChange" :class="{ 'unselected': !共通職業 }">
							<option value="" disabled>職業を選択</option>
							<option v-for="job in 職業リスト" :key="job" :value="job">{{ job }}</option>
						</select>
					</div>
					<div class="flex items-center gap-1">
						<label v-for="type in ['物理', '魔法']" :key="type" class="radio-group">
							<input type="radio" name="physicalOrMagical" :value="type" v-model="inputs.攻撃タイプ">
							<span>{{ type }}</span>
						</label>
					</div>
				</div>

					<!-- スキルが1個の時：横表示 -->
					<div v-if="スキルリスト.length === 1" class="grid grid-cols-4 gap-3">
						<div>
							<label>スキル名</label>
				<select v-model="スキルリスト[0].スキルID" @change="onSkillChange(0)"
					class="skill-name-select" :title="スキルリスト[0].スキル名">
					<option value="">選択</option>
					<option v-for="s in 共通職業選択可能スキル" :key="s.ID" 
						:value="s.ID" :title="s.スキル名">
						{{ s.スキル名 }}
					</option>
						</select>
					</div>
					<div>
						<label>レベル</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].レベル" 
							min="1" :max="getSkillMaxLevel(スキルリスト[0])"
							@change="onSkillLevelChange(0)"
							class="input-full">
					</div>
					<div>
						<label>タイプ</label>
						<button @click="スキルリスト[0].タイプ = スキルリスト[0].タイプ === '召喚' ? '攻撃' : '召喚'"
							class="type-toggle-btn input-full">
							{{ スキルリスト[0].タイプ || '攻撃' }}
						</button>
					</div>
					<div>
						<label>係数</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].倍率" 
							step="0.1" class="input-full">
					</div>
					<div>
						<label>追加ダメ</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].追加ダメ" 
							class="input-full">
					</div>
					<div v-if="スキルリスト[0].タイプ === '召喚'">
						<label>召喚補正</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].召喚補正" 
							class="input-full">
					</div>
					<div>
						<label>HIT数</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].HIT数" 
							min="1" class="input-full">
					</div>
					<div>
						<label>ウェイト</label>
						<input type="number" v-model.lazy.number="スキルリスト[0].ウェイト" 
							min="0" class="input-full">
					</div>
					</div>
					
				<div v-else class="overflow-x-auto">
					<table class="skill-table w-full text-xs">
						<thead>
							<tr>
							<th></th>
							<th class="text-left">スキル名</th>
							<th>Lv</th>
							<th>タイプ</th>
							<th>係数</th>
							<th>追加ダメ</th>
							<th>召喚補正</th>
							<th>HIT数</th>
							<th>ウェイト</th>
							<th></th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(skill, index) in スキルリスト" :key="index"
								:class="{ 'bg-accent bg-opacity-20': index === 選択中スキルインデックス }"
								@click="選択中スキルインデックス = index">
				<td class="text-center">
					<input type="radio" 
						name="selectedSkill" 
						:value="index"
						v-model.number="選択中スキルインデックス"
						class="sr-only">
				</td>
									<td class="skill-name-cell">
					<select v-model="skill.スキルID" @change="onSkillChange(index)"
						class="skill-name-select" :title="skill.スキル名">
						<option value="">選択</option>
					<option v-for="s in 共通職業選択可能スキル" :key="s.ID" 
						:value="s.ID" :title="s.スキル名">
						{{ s.スキル名 }}
					</option>
										</select>
									</td>
							<!-- レベル -->
							<td>
								<input type="number" v-model.lazy.number="skill.レベル" 
									min="1" :max="getSkillMaxLevel(skill)"
									@change="onSkillLevelChange(index)"
									class="input-numeric-xs">
							</td>
							<!-- タイプ（攻撃/召喚） -->
							<td>
								<button @click="skill.タイプ = skill.タイプ === '召喚' ? '攻撃' : '召喚'"
									class="type-toggle-btn">
									{{ skill.タイプ || '攻撃' }}
								</button>
							</td>
							<!-- 倍率 -->
							<td>
								<input type="number" v-model.lazy.number="skill.倍率" 
									step="0.1" class="input-numeric-md">
							</td>
							<!-- 追加ダメ -->
							<td>
								<input type="number" v-model.lazy.number="skill.追加ダメ" 
									class="input-numeric-lg">
							</td>
							<!-- 召喚補正 -->
							<td>
								<input type="number" v-model.lazy.number="skill.召喚補正" 
									v-if="skill.タイプ === '召喚'"
									class="input-numeric-sm">
								<span v-else>-</span>
							</td>
							<!-- HIT数 -->
							<td>
								<input type="number" v-model.lazy.number="skill.HIT数" 
									min="1" class="input-numeric-xs">
							</td>
							<!-- ウェイト -->
							<td>
								<input type="number" v-model.lazy.number="skill.ウェイト" 
									min="0" class="input-numeric-sm">
							</td>
					<!-- 削除ボタン -->
					<td>
					<button v-if="スキルリスト.length > 1" 
						@click.stop="removeスキルタブ(index)"
						class="delete-button">
						×
					</button>
					</td>
								</tr>
							</tbody>
						</table>
					</div>
					
					<!-- 追加ボタン（テーブルの外、中央配置） -->
					<div v-if="スキルリスト.length < 10" class="text-center mt-2">
					<button @click="addスキルタブ" 
						class="add-skill-button">
						+ スキル追加
					</button>
					</div>
				</div>

				<!-- メインコンテンツエリア（2カラム） -->
				<div class="grid-main-content">
					<!-- 左側：敵設定とその他設定 -->
					<div class="space-y-3">

				<!-- 敵設定 -->
				<div class="enemy-settings">
					<div class="label-accent">敵設定</div>
					
					<!-- 反映バランス -->
					<div class="balance-section">
						<label>反映バランス</label>
						<div class="balance-slider-container">
							<span>一般 {{ 100 - ボス重要度 }}%</span>
							<input type="range" v-model.number="ボス重要度" min="0" max="100">
							<span>ボス {{ ボス重要度 }}%</span>
						</div>
					</div>

				<!-- 敵タブボタン（幅いっぱい） -->
				<div class="tab-container">
				<div class="tab-list">
					<button @click="敵タブ = '一般'" 
						class="flex-1"
						:class="{ 'active': 敵タブ === '一般' }">
						一般
					</button>
					<button @click="敵タブ = 'ボス'" 
						class="flex-1"
						:class="{ 'active': 敵タブ === 'ボス' }">
						ボス
					</button>
				</div>
				</div>

				<!-- タブコンテンツ -->
				<div class="tab-content">
					<div v-if="敵タブ">
						<!-- ダンジョン選択 -->
						<div>
							<label>ダンジョン</label>
							<select v-model="this[`ダンジョン_${敵タブ}`]" @change="onDungeonChange(敵タブ)"
								:class="{ 'unselected': !this[`ダンジョン_${敵タブ}`] }">
								<option value="" disabled>ダンジョンを選択</option>
								<option v-for="dungeon in this[`ダンジョンリスト_${敵タブ}`]" :key="dungeon.level" :value="dungeon.name">
									{{ dungeon.name }}
								</option>
							</select>
						</div>

						<!-- 難易度 -->
						<div v-if="this[`ダンジョン_${敵タブ}`]">
							<label>難易度</label>
							<select v-model="this[`難易度_${敵タブ}`]" @change="onDifficultyChange(敵タブ)"
								:class="{ 'unselected': !this[`難易度_${敵タブ}`] }">
								<option value="" disabled>選択</option>
								<option v-for="difficulty in this[`選択可能難易度_${敵タブ}`]" :key="difficulty" :value="difficulty">
									{{ difficulty }}
								</option>
							</select>
						</div>
						
						<!-- 敵 -->
						<div v-if="this[`ダンジョン_${敵タブ}`]">
							<label>敵</label>
							<select v-model="this[`敵名_${敵タブ}`]" @change="onEnemyChange(敵タブ)" 
								:class="{ 'unselected': !this[`敵名_${敵タブ}`] }">
								<option value="" disabled>選択</option>
								<option v-for="enemy in this[`選択可能敵_${敵タブ}`]" :key="enemy" :value="enemy">
									{{ enemy }}
								</option>
							</select>
						</div>

					<!-- ステータス入力（v-forでループ化） -->
					<div v-for="stat in ['防御', '幸運', 'クリ減', 'ダメ減', 'ダメ減%']" :key="stat">
						<label>{{ stat }}</label>
						<input type="number" 
							v-model.lazy.number="敵ステータス[stat === 'ダメ減%' ? 'ダメ減_乗算' : stat]" 
							@blur="triggerCalculation">
					</div>
					</div>
				</div>
				</div>

					<!-- HPダメージ換算設定 -->
					<div class="other-settings">
						<div class="label-accent">その他設定</div>
						<div class="hp-value-setting">
							<label>HPダメージ換算</label>
							<input type="number" id="HPダメージ換算" v-model.lazy.number="inputs.HPダメージ換算" min="0" max="100"
								title="HP100%増加を火力何％換算するか" @blur="triggerCalculation">
							<span>%</span>
						</div>
						<!-- 換算方法選択 -->
						<div>
							<label>換算方法</label>
							<div class="flex-gap-4">
								<label v-for="method in ['増加ダメ', 'クリダメ換算', '筋魔換算']" :key="method" class="radio-group">
									<input type="radio" name="conversionMethod" :value="method" v-model="換算方法">
									<span>{{ method }}</span>
								</label>
							</div>
						</div>
					</div>
						</div>

						<!-- 右側：ステータス入力エリア -->
						<div class="status-container">
							<!-- 共通ステータス -->
							<template v-for="stat in statKeys" :key="stat">
								<!-- 攻撃特殊レイアウト -->
								<template v-if="stat=='攻撃最小'"></template>
								<div v-else-if="stat=='攻撃最大'" class="attack-stats-grid">
									<!-- 攻撃_最大 -->
									<div class="input-group">
										<label>攻撃最大</label>
										<input type="number" id="攻撃最大" v-model.lazy.number="inputs.stats['攻撃最大']"
											@blur="triggerCalculation">
										<label>+</label>
										<span>{{ Math.floor(base('攻撃最大')) }}</span>
								<span>({{ incr('攻撃最大') }})</span>
									</div>
									<!-- 攻撃_最小 -->
									<div class="input-group">
										<label>攻撃最小</label>
										<input type="number" id="攻撃最小" v-model.lazy.number="inputs.stats['攻撃最小']"
											@blur="triggerCalculation">
										<label>+</label>
										<span>{{ Math.floor(base('攻撃最小')) }}</span>
								<span>({{ incr('攻撃最小') }})</span>
									</div>
									<!-- 攻撃_乗算 -->
									<label>%</label>
									<input type="number" id="攻撃_乗算" v-model.lazy.number="inputs.stats['攻撃_乗算']"
										@blur="triggerCalculation">
							<span>({{ incr('攻撃_乗算') }})</span>
								</div>

								<div class="input-group" v-else>
									<label>{{ label(stat) }}</label>
									<input type="number" :id="stat" v-model.lazy.number="inputs.stats[stat]" @blur="triggerCalculation">
									<template v-if="hasMultiplier(stat)">
										<label>+</label>
										<span>{{ Math.floor(base(stat)) }}</span>
								<span>({{ incr(stat) }})</span>
										<label>{{ label(mulKey(stat)) }}</label>
										<input type="number" :id="mulKey(stat)" v-model.lazy.number="inputs.stats[mulKey(stat)]"
											@blur="triggerCalculation">
								<span>({{ incr(mulKey(stat)) }})</span>
									</template>
				<template v-else>
					<span>({{ incr(stat) }})</span>
				</template>
								</div>
							</template>
						</div>
					</div>
				</div>

				<!-- 換算表タブ -->
				<div v-else>
					<h3 class="section-header">
						{{ tabLabels[activeMainTab] + ' ランキング' }}
					</h3>

	<!-- 覚醒ポイント入力（覚醒1と覚醒2） -->
	<div v-if="activeMainTab === 'awaken1' || activeMainTab === 'awaken2'" class="mb-4">
		<div class="flex items-center gap-4 mb-3">
			<div class="flex items-center gap-2 px-3 py-2 bg-bg-secondary border border-border rounded-lg">
				<label class="text-xs">ポイント：</label>
				<input v-if="activeMainTab === 'awaken1'" type="number" 
					v-model.number="覚醒1ポイント"
					min="0" max="300"
					class="w-20 px-2 py-1 border rounded text-sm">
				<input v-else type="number" 
					v-model.number="覚醒2ポイント"
					min="0" max="300"
					class="w-20 px-2 py-1 border rounded text-sm">
				<button @click="autoOptimizeAwaken" 
					class="px-3 py-1 bg-accent text-white text-sm rounded hover:bg-accent-hover transition-colors">
					オート
				</button>
			</div>
			<button @click="resetAwakenCanvas" 
				class="px-3 py-1 bg-gray-400 text-white text-sm rounded hover:bg-gray-500 transition-colors">
				リセット
			</button>
		</div>
			
	<!-- Canvas表示エリア（アスペクト比1940:1060を維持） -->
	<div class="relative border rounded overflow-hidden" style="width: 100%; max-width: 1000px; aspect-ratio: 1940 / 1060; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
		<canvas id="awaken1-canvas" 
			v-if="activeMainTab === 'awaken1'"
			style="width: 100%; height: 100%; cursor: pointer;"></canvas>
		<canvas id="awaken2-canvas" 
			v-if="activeMainTab === 'awaken2'"
			style="width: 100%; height: 100%; cursor: pointer;"></canvas>
				
				<!-- ツールチップ -->
				<div id="awaken-tooltip" 
					class="absolute bg-black bg-opacity-80 text-white p-2 rounded pointer-events-none z-10"
					style="display: none; max-width: 250px;">
				</div>
			</div>
		</div>

			<!-- ギルドスキルフィルタ（特殊UI） -->
			<div v-if="activeMainTab === 'guild'" class="filter-group">
				<label v-for="grade in ['初級', '中級', '上級']" :key="grade" class="filter-checkbox">
					<input type="checkbox" v-model="guildSkillGradeFilters[grade]" :disabled="isLastCheckedGuildGrade(grade)">
					<span>{{ grade }}</span>
				</label>
			</div>

		<div v-if="!activeMainTab.startsWith('awaken')" class="table-wrapper">
					<table class="data-table">
						<thead>
							<tr>
								<th v-for="header in activeRanking.headers" :key="header">{{ header }}</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(item, index) in (activeMainTab === 'guild' ? activeRanking.data : activeRanking.data.slice(0, 1000))" :key="`${activeMainTab}-${item.id}`">
								<td>{{ index + 1 }}</td>
								<td v-if="'name' in item">{{ item.name }}</td>
								<td v-if="'category' in item">{{ item.category }}</td>
								<td v-if="'route' in item">{{ item.route }}</td>
								<td v-if="'stats' in item">{{ item.stats }}</td>
								<td v-if="'effect' in item" v-html="item.effect"></td>
								<td v-if="'level' in item">{{ item.level }}</td>
								<td v-if="'cost' in item">{{ item.cost }}</td>
				<td v-if="'damage' in item">{{ (activeMainTab === 'guild' || activeMainTab.startsWith('awaken') || 換算方法 !== '増加ダメ') ? item.damage.toFixed(4) : formatDamage(item.damage) }}</td>
							</tr>
						</tbody>
					</table>
				</div>
		</div>
	</div>

	<!-- 静的データファイル -->
	<script src="js/data/skills-data.js"></script>
	<script src="js/data/enemies-data.js"></script>
	<script src="js/data/transcend-skills-data.js"></script>
	<script src="js/data/guild-skills-data.js"></script>
	<script src="js/data/pet-passives-data.js"></script>
	<script src="js/data/awaken-skills-data.js"></script>
	<script src="js/data/awaken-coords-data.js"></script>
	<!-- メインアプリケーション -->
	<script src="bundle.min.js"></script>
</body>

</html>
